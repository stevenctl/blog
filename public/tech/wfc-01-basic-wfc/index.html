<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="light"
  data-auto-appearance="false"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>3D Autotiling: Basic WFC &middot; Dirt is Food</title>
  <meta name="title" content="3D Autotiling: Basic WFC &middot; Dirt is Food" />
  
  
  
  
  
  <link rel="canonical" href="https://landow.dev/tech/wfc-01-basic-wfc/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.c6cb7d76bc2f7ad3b49117792dc4c22ec9879b2a91fa3bc6abe4f5e2072998a2acd74d88c828d3aa4c09c262aec6740a233b56dc9c2f1e35bf9f400581150cc2.css"
    integrity="sha512-xst9drwvetO0kRd5LcTCLsmHmyqR&#43;jvGq&#43;T14gcpmKKs102IyCjTqkwJwmKuxnQKIztW3JwvHjW/n0AFgRUMwg==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  <script src="/js/zoom.min.js"></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="3D Autotiling: Basic WFC" />
<meta property="og:description" content="Introduction # I don&rsquo;t think I would have become interested in shooters if it weren&rsquo;t for Halo 3&rsquo;s forge mode. I probably logged 1000 hours in Minecraft when I was a kid (and learned Java because of it!). Games that let you make stuff are the best. Making games is even better. After a few years focusing on my career in network programming I decided to revisit games, this time looking at 3D." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://landow.dev/tech/wfc-01-basic-wfc/" /><meta property="og:image" content="https://landow.dev/tech/wfc-01-basic-wfc/featured.png" /><meta property="article:section" content="tech" />




  <meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://landow.dev/tech/wfc-01-basic-wfc/featured.png" /><meta name="twitter:title" content="3D Autotiling: Basic WFC"/>
<meta name="twitter:description" content="Introduction # I don&rsquo;t think I would have become interested in shooters if it weren&rsquo;t for Halo 3&rsquo;s forge mode. I probably logged 1000 hours in Minecraft when I was a kid (and learned Java because of it!). Games that let you make stuff are the best. Making games is even better. After a few years focusing on my career in network programming I decided to revisit games, this time looking at 3D."/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Techincal Posts",
    "name": "3D Autotiling: Basic WFC",
    "headline": "3D Autotiling: Basic WFC",
    
    "abstract": "Introduction # I don\u0026rsquo;t think I would have become interested in shooters if it weren\u0026rsquo;t for Halo 3\u0026rsquo;s forge mode. I probably logged 1000 hours in Minecraft when I was a kid (and learned Java because of it!). Games that let you make stuff are the best. Making games is even better. After a few years focusing on my career in network programming I decided to revisit games, this time looking at 3D.",
    "inLanguage": "en",
    "url" : "https:\/\/landow.dev\/tech\/wfc-01-basic-wfc\/",
    "author" : {
      "@type": "Person",
      "name": "Steven Landow"
    },
    
    
    
    
    
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2527"
  }]
  </script>


  
  
  <meta name="author" content="Steven Landow" />
  
  
  
  <link href="https://github.com/stevenctl" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.js" integrity=""></script>


















  
  

  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">Dirt is Food</span>

            <img src="/logo.png" width="250" height="250"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Dirt is Food" />

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Dirt is Food</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/art/"  class="flex items-center">
    
    <p class="text-base font-medium text-gray-500 hover:text-gray-900" title="Art">
        Art
    </p>
</a>


            
            
  <a href="/tech/"  class="flex items-center">
    
    <p class="text-base font-medium text-gray-500 hover:text-gray-900" title="Techincal Posts">
        Techincal Posts
    </p>
</a>


            
            

            


            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button">
                    <div class="flex items-center justify-center h-12 dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden h-12 dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12">

            <span></span>

            


            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" style="margin-right:5px">
                <div class="flex items-center justify-center h-12 dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden h-12 dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" for="menu-controller" class="block">
            <input type="checkbox" id="menu-controller" class="hidden" />
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li>
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/art/"  class="flex items-center">
        
        <p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="Art">
            Art
        </p>
    </a>
</li>



                    

                    
  <li class="mt-1">
    <a href="/tech/"  class="flex items-center">
        
        <p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="Techincal Posts">
            Techincal Posts
        </p>
    </a>
</li>



                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>





  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      3D Autotiling: Basic WFC
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  

























<div class="flex flex-row flex-wrap items-center">
  
  

  
  
</div>







    </div>

    
    
    
    
    

    

    

    

    
  
  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10">

         <details open class="toc-right mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#2d-autotiling-with-marching-squares">2D Autotiling with Marching Squares</a>
      <ul>
        <li><a href="#lookup-table">Lookup Table</a></li>
        <li><a href="#cursor">Cursor</a></li>
        <li><a href="#bit-flipping">Bit Flipping</a></li>
        <li><a href="#lookup-and-draw">Lookup and Draw</a></li>
      </ul>
    </li>
    <li><a href="#basic-wave-function-collapse">Basic Wave Function Collapse</a>
      <ul>
        <li><a href="#algorithm">Algorithm</a></li>
        <li><a href="#types">Types</a></li>
        <li><a href="#implementation">Implementation</a></li>
        <li><a href="#generating-sockets-and-prototypes">Generating Sockets and Prototypes</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#2d-autotiling-with-marching-squares">2D Autotiling with Marching Squares</a>
      <ul>
        <li><a href="#lookup-table">Lookup Table</a></li>
        <li><a href="#cursor">Cursor</a></li>
        <li><a href="#bit-flipping">Bit Flipping</a></li>
        <li><a href="#lookup-and-draw">Lookup and Draw</a></li>
      </ul>
    </li>
    <li><a href="#basic-wave-function-collapse">Basic Wave Function Collapse</a>
      <ul>
        <li><a href="#algorithm">Algorithm</a></li>
        <li><a href="#types">Types</a></li>
        <li><a href="#implementation">Implementation</a></li>
        <li><a href="#generating-sockets-and-prototypes">Generating Sockets and Prototypes</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
  </div>
</details>

   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          <video src="02-basic-wfc/generate.webm" autoplay muted loop></video>

<h2 class="relative group">Introduction 
    <div id="introduction" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#introduction" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>I don&rsquo;t think I would have become interested in shooters if it weren&rsquo;t for Halo
3&rsquo;s forge mode. I probably logged 1000 hours in Minecraft when I was a kid (and
learned Java because of it!). Games that let you make stuff are the best. Making
games is even better. After a few years focusing on my career in network programming
I decided to revisit games, this time looking at 3D.</p>
<p>I picked up a book on 3D modeling and then tried to start making a game.
Building a castle felt a bit tedious to me, even with a modular kitbash asset pack.
In 2D and 3D, I hate rotating and aligning tiles to fit.</p>
<p>In <a href="https://www.townscapergame.com/"   target="_blank">
    Townscaper</a>, it&rsquo;s very easy to build something
that looks &ldquo;correct&rdquo;. I wanted to replicate that experience in a level editor. This
led me down a rabbit hole into exploring different procedural generation techniques:
Wave Function Collapse, Marching Cubes for terrain, Heightmap Terrain. The hardest part was
modifying them to make them artist controllable.</p>
<p>This short series covers my Wave Function Collapse implementation. I&rsquo;ve implemented
the core algorithm 4 times. First in Blender/Python intending to export to Unity/C#.
Unity had issues on my Linux machine so I tried Bevy/Rust. Turns out an editor is a
valuable debugging tool and I finally have a solid working version in Godot.</p>
<h2 class="relative group">2D Autotiling with Marching Squares 
    <div id="2d-autotiling-with-marching-squares" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#2d-autotiling-with-marching-squares" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>There are lots of <a href="https://www.boristhebrave.com/2021/09/12/beyond-basic-autotiling/"   target="_blank">
    better choices for 2D autotiling</a>.
This tutorial is a baby step towards what I  truly want to show.</p>
<p><a href="https://en.wikipedia.org/wiki/Marching_squares"   target="_blank">
    Marching Squares</a> and it&rsquo;s 3D
cousin <a href="https://en.wikipedia.org/wiki/Marching_cubes"   target="_blank">
    Marching Cubes</a> are both
algorithms for converting an array of scalar values into a shape or mesh. These
algorithms are pretty robust and with high enough resolution and smart
interpolation, they will produce a very nice output.</p>
<p>Both algorithms operate on a dual grid. You can think of this as having a
secondary grid offset by half a cell. I prefer to imagine the cells as
containing data and the corners of the cells containing separate but related
data. In this case, the corners of the grid represent the &ldquo;density&rdquo; information.
That could be a &lsquo;0<code>meaning &quot;empty,&quot; or a</code>1` indicating &ldquo;filled.&rdquo; If we want a
smoothed result, we could use an arbitrary scalar value telling us <em>how</em> full it
is.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/01-marching-squares/grid_hufd7daa78f73a0ea9a2b095306d3c61af_357807_330x0_resize_q75_box.jpg 330w,
        /tech/wfc-01-basic-wfc/01-marching-squares/grid_hufd7daa78f73a0ea9a2b095306d3c61af_357807_660x0_resize_q75_box.jpg 660w,
        /tech/wfc-01-basic-wfc/01-marching-squares/grid_hufd7daa78f73a0ea9a2b095306d3c61af_357807_1024x0_resize_q75_box.jpg 1024w,
        /tech/wfc-01-basic-wfc/01-marching-squares/grid_hufd7daa78f73a0ea9a2b095306d3c61af_357807_1320x0_resize_q75_box.jpg 2x"
        src="/tech/wfc-01-basic-wfc/01-marching-squares/grid_hufd7daa78f73a0ea9a2b095306d3c61af_357807_660x0_resize_q75_box.jpg"
        alt="scalar grid"
      />
      
      
    </figure>
  

</p>
<p>The goal here is 2D auto-tiling, not generating a smooth mesh. So we can treat
the corners as either filled or empty. We have four corners per cell with two
possibilities. That&rsquo;s 2‚Å¥ (16) total combinations.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/01-marching-squares/cases_hufd7daa78f73a0ea9a2b095306d3c61af_179472_330x0_resize_q75_box.jpg 330w,
        /tech/wfc-01-basic-wfc/01-marching-squares/cases_hufd7daa78f73a0ea9a2b095306d3c61af_179472_660x0_resize_q75_box.jpg 660w,
        /tech/wfc-01-basic-wfc/01-marching-squares/cases_hufd7daa78f73a0ea9a2b095306d3c61af_179472_1024x0_resize_q75_box.jpg 1024w,
        /tech/wfc-01-basic-wfc/01-marching-squares/cases_hufd7daa78f73a0ea9a2b095306d3c61af_179472_1320x0_resize_q75_box.jpg 2x"
        src="/tech/wfc-01-basic-wfc/01-marching-squares/cases_hufd7daa78f73a0ea9a2b095306d3c61af_179472_660x0_resize_q75_box.jpg"
        alt="cases"
      />
      
      
    </figure>
  

</p>
<p>Depending on the art style, you may not need unique tiles for the same shape in
different directions. If we remove cases that are mirrors or rotations of
others, we only have five things to draw. Notice that in that <code>2b</code>, the diagonal
case can either be a gap or a bridge. In marching squares, this is called a
saddle point. We&rsquo;re just going to make that an artistic/gameplay choice here.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/01-marching-squares/uniq_hu2a683a8029d426eaa375dcebfe993b9b_108836_330x0_resize_q75_box.jpg 330w,
        /tech/wfc-01-basic-wfc/01-marching-squares/uniq_hu2a683a8029d426eaa375dcebfe993b9b_108836_660x0_resize_q75_box.jpg 660w,
        /tech/wfc-01-basic-wfc/01-marching-squares/uniq_hu2a683a8029d426eaa375dcebfe993b9b_108836_1024x0_resize_q75_box.jpg 1024w,
        /tech/wfc-01-basic-wfc/01-marching-squares/uniq_hu2a683a8029d426eaa375dcebfe993b9b_108836_1320x0_resize_q75_box.jpg 2x"
        src="/tech/wfc-01-basic-wfc/01-marching-squares/uniq_hu2a683a8029d426eaa375dcebfe993b9b_108836_660x0_resize_q75_box.jpg"
        alt="unique tiles"
      />
      
      
    </figure>
  

</p>
<p>For this tutorial, I&rsquo;m going to use Godot with GDScript. Feel free to follow
along with whatever you&rsquo;re comfortable with.</p>
<h3 class="relative group">Lookup Table 
    <div id="lookup-table" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#lookup-table" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>We can think of each corner as one bit of a 4-bit integer. Starting in the top
left, moving in clockwise order, we will set the least significant bit for each
&ldquo;filled&rdquo; corner.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> lookup <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># empty</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">0</span>}, 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># corner </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">1</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">8</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">4</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">2</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">3</span>},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># edge </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">3</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">6</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">3</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">9</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">12</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># diagonal </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">5</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">10</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># bend</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">7</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">11</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">13</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">14</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">3</span>},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># full</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">15</span>: {<span style="color:#e6db74">&#34;tile&#34;</span>: <span style="color:#ae81ff">5</span>, <span style="color:#e6db74">&#34;rotation&#34;</span>: <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Here I a dictionary to make it easier to write by hand.
Usually you&rsquo;ll see this as an array, especially when
passing it to a compute shader.</span>
</div>

<h3 class="relative group">Cursor 
    <div id="cursor" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cursor" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<video src="01-marching-squares/step-1.webm" autoplay muted loop></video>

<p>Pretty simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_ready</span>():
</span></span><span style="display:flex;"><span>	cursor <span style="color:#f92672">=</span> <span style="color:#a6e22e">ColorRect</span><span style="color:#f92672">.</span><span style="color:#a6e22e">new</span>()
</span></span><span style="display:flex;"><span>	cursor<span style="color:#f92672">.</span>color <span style="color:#f92672">=</span> <span style="color:#a6e22e">Color</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>	cursor<span style="color:#f92672">.</span>size <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span>(TILE_SIZE, TILE_SIZE)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">add_child</span>(self<span style="color:#f92672">.</span>cursor)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_input</span>(event):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> event <span style="color:#f92672">is</span> <span style="color:#a6e22e">InputEventMouse</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> rounded <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2i</span>(event<span style="color:#f92672">.</span>position <span style="color:#f92672">/</span> TILE_SIZE) <span style="color:#f92672">*</span> TILE_SIZE
</span></span><span style="display:flex;"><span>		self<span style="color:#f92672">.</span>cursor<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> rounded
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> event <span style="color:#f92672">is</span> <span style="color:#a6e22e">InputEventMouseButton</span> <span style="color:#f92672">and</span> event<span style="color:#f92672">.</span><span style="color:#a6e22e">is_pressed</span>():
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">_toggle</span>(rounded)
</span></span></code></pre></div><h3 class="relative group">Bit Flipping 
    <div id="bit-flipping" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#bit-flipping" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>First we add a top level dictionary:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#a6e22e">Vector2i</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> tiles <span style="color:#f92672">=</span> {}
</span></span></code></pre></div><p>We will key the dictionary by the <code>Vector2i</code> coordinate where we want to draw
the tile. The value is the index to use in the lookup table. We will mani</p>
<p>We manipulate the index at the four surrounding coordinates when we click on the
grid. We can think of the coordinates we click on as the &ldquo;corners&rdquo; or the &ldquo;dual
grid&rdquo; of the grid that tiles draw. The bit we change must correspond to the
corner of the tile grid cell on which this &ldquo;dual&rdquo; coordinate lies. Since the
bottom right corner uses the the first bit, we start with that and then go
counterclockwise.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> offsets <span style="color:#f92672">=</span>  [
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Vector2i</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Vector2i</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Vector2i</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Vector2i</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>), 
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_toggle</span>(pos: <span style="color:#a6e22e">Vector2i</span>):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> grid_coord <span style="color:#f92672">=</span> pos <span style="color:#f92672">/</span> TILE_SIZE
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(offsets)):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> offset_coord <span style="color:#f92672">=</span> grid_coord <span style="color:#f92672">+</span> offsets[i]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> offset_coord <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> tiles:
</span></span><span style="display:flex;"><span>			tiles[offset_coord] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		tiles[offset_coord] <span style="color:#f92672">^=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> i
</span></span></code></pre></div><h3 class="relative group">Lookup and Draw 
    <div id="lookup-and-draw" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#lookup-and-draw" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Finally, we can do a lookup using the index which we just modified.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">_toggle</span>(pos: <span style="color:#a6e22e">Vector2i</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(offsets)):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># flip a bit </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    	<span style="color:#66d9ef">var</span> s <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_node_or_null</span>(str(offset_coord))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> s:
</span></span><span style="display:flex;"><span>			s <span style="color:#f92672">=</span> <span style="color:#a6e22e">Sprite2D</span><span style="color:#f92672">.</span><span style="color:#a6e22e">new</span>()
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> str(offset_coord)
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span>texture <span style="color:#f92672">=</span> tileset
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span>region_enabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> (offset_coord <span style="color:#f92672">+</span> <span style="color:#a6e22e">Vector2i</span><span style="color:#f92672">.</span>DOWN) <span style="color:#f92672">*</span> TILE_SIZE
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">add_child</span>(s)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> tiles[offset_coord] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span><span style="color:#a6e22e">queue_free</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">var</span> tile <span style="color:#f92672">=</span> lookup[tiles[offset_coord]]		
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span>region_rect <span style="color:#f92672">=</span> <span style="color:#a6e22e">Rect2</span>(tile[<span style="color:#e6db74">&#34;tile&#34;</span>] <span style="color:#f92672">*</span> TILE_SIZE, <span style="color:#ae81ff">0</span>, TILE_SIZE, TILE_SIZE)		
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">.</span>rotation_degrees <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span> <span style="color:#f92672">*</span> tile[<span style="color:#e6db74">&#34;rotation&#34;</span>]
</span></span></code></pre></div><video src="01-marching-squares/demo.webm" autoplay muted loop></video>

<p>Pretty simple. Less than 100 lines of code and we have a working demo.
Extending this to 3 dimensions isn&rsquo;t difficult. Instad of each cell having
four corners, it has 8. The hard part is building a tileset and lookup table
that can support 2‚Å∏ (256) possibilities.</p>
<h2 class="relative group">Basic Wave Function Collapse 
    <div id="basic-wave-function-collapse" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#basic-wave-function-collapse" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This 3D autotiling project started when I stumbled on <a href="https://www.youtube.com/watch?v=2SuvO4Gi7uY"   target="_blank">
    Martin Donald&rsquo;s Wave
Function Collapse video</a>. He
explained it so well that I had to try it out.</p>
<p>In this post I will attempt to outline the high-level structure of a Wave
Function Collapse implementation with a bit of pseudo-Python. This is not a
tutorial, but more of a brief recap of my first implementation from over a year
ago.</p>
<h3 class="relative group">Algorithm 
    <div id="algorithm" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#algorithm" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>The algorithm has two main phases: Collapse and propagation. Collapse is a cute
name for picking a value for some cell. When we observe the cell reduces its
superposition of possible states into a single value. Propagation is where we
use that definite value to narrow down the possible values of neighboring
cells.</p>

  
  
  
  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >ü§¶ I used the word Collapse instead of Observe/Observation. Collapse is what
happens due to observation and propagation. Oops.</span>
</div>

<p>We start with a grid and a tileset. Each cell of the grid contains all of the
tiles as its possibilities.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/02-basic-wfc/01-all_hu2b02223c55b64620c9e03fb5cf9fcee8_219582_330x0_resize_box_3.png 330w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/01-all_hu2b02223c55b64620c9e03fb5cf9fcee8_219582_660x0_resize_box_3.png 660w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/01-all_hu2b02223c55b64620c9e03fb5cf9fcee8_219582_1024x0_resize_box_3.png 1024w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/01-all_hu2b02223c55b64620c9e03fb5cf9fcee8_219582_1320x0_resize_box_3.png 2x"
        src="/tech/wfc-01-basic-wfc/02-basic-wfc/01-all_hu2b02223c55b64620c9e03fb5cf9fcee8_219582_660x0_resize_box_3.png"
        alt="all tiles in all cells"
      />
      
      
    </figure>
  

</p>
<p>Next, we pick a random tile for one of the cells. Because the &ldquo;square&rdquo; socket
is on the right side of the tile we picked, the next cell can only contain
tiles that match that socket on the adjacent side. That propagates out into the
third cell as well. Our middle cell only exposes a triangle and a square so the
tile with a circle on the left gets eliminated.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/02-basic-wfc/02-choice_hu53268562325b2e32e819304d2ecea6de_270229_330x0_resize_box_3.png 330w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/02-choice_hu53268562325b2e32e819304d2ecea6de_270229_660x0_resize_box_3.png 660w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/02-choice_hu53268562325b2e32e819304d2ecea6de_270229_1024x0_resize_box_3.png 1024w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/02-choice_hu53268562325b2e32e819304d2ecea6de_270229_1320x0_resize_box_3.png 2x"
        src="/tech/wfc-01-basic-wfc/02-basic-wfc/02-choice_hu53268562325b2e32e819304d2ecea6de_270229_660x0_resize_box_3.png"
        alt="pick one"
      />
      
      
    </figure>
  

</p>
<p>From this state, if we choose the &ldquo;edge&rdquo; tile with the triangle socket for the
middle cell there is only one compatible tile in the rightmost cell, therefore
the grid is solved. If we choose another completely blue tile here, we must
make one more choice.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/02-basic-wfc/tree_hue16b5a5d2d8a6e87286391005591a211_147236_330x0_resize_q75_box.jpg 330w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/tree_hue16b5a5d2d8a6e87286391005591a211_147236_660x0_resize_q75_box.jpg 660w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/tree_hue16b5a5d2d8a6e87286391005591a211_147236_1024x0_resize_q75_box.jpg 1024w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/tree_hue16b5a5d2d8a6e87286391005591a211_147236_1320x0_resize_q75_box.jpg 2x"
        src="/tech/wfc-01-basic-wfc/02-basic-wfc/tree_hue16b5a5d2d8a6e87286391005591a211_147236_660x0_resize_q75_box.jpg"
        alt="decision tree"
      />
      
      
    </figure>
  

</p>
<p>We end up with a solid number of possible final states even in our limited
example. The number of choices is less than or equal to the number of cells.
In practice, we rarely make a random choice for the majority cells. After a
few essential cells are collapsed, the propagation step chooses by process of
elimination. The worst case, performance-wise, is if we have so many compatible tiles
that we don&rsquo;t quickly prune possibilities in the first few iterations.</p>
<h3 class="relative group">Types 
    <div id="types" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#types" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>I have a handful of foundational structures in my implementation.</p>
<h4 class="relative group">Prototypes 
    <div id="prototypes" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#prototypes" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Prototype</span>:
</span></span><span style="display:flex;"><span>    name: str
</span></span><span style="display:flex;"><span>    mesh: str
</span></span><span style="display:flex;"><span>    rotation: int
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sockets</span>
</span></span><span style="display:flex;"><span>    north: str
</span></span><span style="display:flex;"><span>    east: str
</span></span><span style="display:flex;"><span>    south: str
</span></span><span style="display:flex;"><span>    west: str
</span></span><span style="display:flex;"><span>    top: str
</span></span><span style="display:flex;"><span>    bottom: str
</span></span></code></pre></div><p>A prototype represents a possible choice to put somewhere in the grid. We will
have 4 prototypes for each tile in our tileset, one for each 90-degree
rotation.</p>
<h4 class="relative group">Sockets 
    <div id="sockets" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#sockets" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>On each of the 6 faces we will have a socket. These identify which <code>Prototype</code>s
can connect to each other in each direction. The socket represents what we see
when we look at one face of the tile&rsquo;s bounding box.</p>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/02-basic-wfc/socket_hu56c3339011fa593eb9391588ffd46d56_46987_330x0_resize_q75_box.jpg 330w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/socket_hu56c3339011fa593eb9391588ffd46d56_46987_660x0_resize_q75_box.jpg 660w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/socket_hu56c3339011fa593eb9391588ffd46d56_46987_1024x0_resize_q75_box.jpg 1024w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/socket_hu56c3339011fa593eb9391588ffd46d56_46987_1320x0_resize_q75_box.jpg 2x"
        src="/tech/wfc-01-basic-wfc/02-basic-wfc/socket_hu56c3339011fa593eb9391588ffd46d56_46987_660x0_resize_q75_box.jpg"
        alt="highlighted socket"
      />
      
      
    </figure>
  

</p>
<p>For the north and south or east and west sockets to match, they must be mirrors
of one another. For a vertical face&rsquo;s socket to fit the sockets must be
identical. Sockets are arbitrary strings, except for the suffixes on horizontal
faces&rsquo; sockets: <code>s</code> (symmetrical) and <code>f</code> (flipped).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compatible_sockets</span>(face, a, b) <span style="color:#f92672">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># symmetrical faces should be identical</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> face <span style="color:#f92672">in</span> {<span style="color:#e6db74">&#34;top&#34;</span>, <span style="color:#e6db74">&#34;bottom&#34;</span>} <span style="color:#f92672">or</span> a<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;s&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">==</span> b     
</span></span><span style="display:flex;"><span>    flipped_b <span style="color:#f92672">=</span> socket[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">if</span> socket<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;f&#34;</span>) <span style="color:#66d9ef">else</span> b <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;f&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">==</span> flipped(b)
</span></span></code></pre></div><h4 class="relative group">Cells 
    <div id="cells" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cells" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cell</span>:
</span></span><span style="display:flex;"><span>    possibilities: list[Prototype]
</span></span></code></pre></div><p>A cell is one element in a <code>Grid</code>, which is just a collection of <code>Cell</code>s.</p>
<h4 class="relative group">Grid 
    <div id="grid" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#grid" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>How you represetnt a <code>Grid</code> depends on your application. BorisTheBrave wrote an
entire C# library, <a href="02-basic-wfc/https://boristhebrave.com/docs/sylves/1/"  >
    Sylves</a>, for
handling grids.</p>
<p>It could be a 3D array:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Grid</span>:
</span></span><span style="display:flex;"><span>    grid: list[list[list[Cell]]]
</span></span></code></pre></div><p>Or for an infinite grid, a map that lazily populated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Grid</span>:
</span></span><span style="display:flex;"><span>    grid: dict[Vec3, Cell]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __getitem__(self, coord: Vec3):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>grid:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>grid[coord] <span style="color:#f92672">=</span> Cell()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>grid[coord]
</span></span></code></pre></div><p>Our only requirement is that we can use a 3D coordinate as a key.</p>
<h3 class="relative group">Implementation 
    <div id="implementation" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#implementation" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">solve</span>():
</span></span><span style="display:flex;"><span>    work_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    solved <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    iteration <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> solved <span style="color:#f92672">and</span> iteration <span style="color:#f92672">&lt;</span> MAX_ITERATIONS:
</span></span><span style="display:flex;"><span>        iteration <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cell, coord <span style="color:#f92672">=</span> grid<span style="color:#f92672">.</span>find_min_entropy()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cell <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            solved <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cell<span style="color:#f92672">.</span>collapse()
</span></span><span style="display:flex;"><span>        work_list<span style="color:#f92672">.</span>append(coord)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> len(work_list) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            work_list <span style="color:#f92672">+=</span> propagate(work_list<span style="color:#f92672">.</span>pop())
</span></span></code></pre></div><p>Here is the algorithm we described earlier:</p>
<ol>
<li>Make a random selection in one of the cells</li>
<li>Recursively propagate that out and repeat until every cell has only
one possibility.</li>
</ol>
<p>You can perform the selection bit by hand in this <a href="https://bolddunkley.itch.io/wfc-mixed"   target="_blank">
    web
demo</a> from <a href="https://www.youtube.com/@MartinDonald"   target="_blank">
    Martin Donald</a>.</p>
<h4 class="relative group">Collapse 
    <div id="collapse" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#collapse" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>In this algorithm, &ldquo;entropy&rdquo; is a cute name for the length of a <code>Cell</code>&rsquo;s
possibility list. Zero means there is a contradiction and we will never be able
to solve the <code>Grid</code>. One means we have already chosen the <code>Prototype</code> for
this cell. In each iteration, we find the unsolved Cell we&rsquo;re most certain
about:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">min_entropy</span>(self) <span style="color:#f92672">-&gt;</span> Cell:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">entropy</span>(cell):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cell<span style="color:#f92672">.</span>entropy() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> math<span style="color:#f92672">.</span>inf
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cell<span style="color:#f92672">.</span>entropy()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> min(self<span style="color:#f92672">.</span>grid, key<span style="color:#f92672">=</span>entropy)
</span></span></code></pre></div><p>Then we &ldquo;collapse&rdquo; its possibilities into a random choice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">collapse</span>(self):
</span></span><span style="display:flex;"><span>    idx <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">0</span>, len(self<span style="color:#f92672">.</span>possibilities) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>possibilities <span style="color:#f92672">=</span> [self<span style="color:#f92672">.</span>possibilities[idx]]
</span></span></code></pre></div><h4 class="relative group">Propagate 
    <div id="propagate" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#propagate" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">propagate</span>(coord):
</span></span><span style="display:flex;"><span>    cur_cell <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>grid<span style="color:#f92672">.</span>get(cur_coord)
</span></span><span style="display:flex;"><span>    changed_neighbors <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> direction <span style="color:#f92672">in</span> opposing_faces<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>        next_coord <span style="color:#f92672">=</span> add_vec3(cur_coord, face_deltas[direction])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>grid<span style="color:#f92672">.</span>is_in_bounds(next_coord):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        next_cell <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>grid<span style="color:#f92672">.</span>get(next_coord)
</span></span><span style="display:flex;"><span>        changed <span style="color:#f92672">=</span> grid[next_cell]<span style="color:#f92672">.</span>constrain_to_neighbor(cur_cell, direction)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> changed:
</span></span><span style="display:flex;"><span>            changed_neighbors<span style="color:#f92672">.</span>append(next_coord)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>propagation_stack<span style="color:#f92672">.</span>append(next_coord)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> changed_neighbors
</span></span></code></pre></div><p>Any time we change the possibility list of one cell,
the neighboring cells are possibly affected. We reduce the possibility list
of each adjacent cell with <code>constrain_to_neighbor</code>, and if that causes
a change, we will have to propagate to <em>that</em> cell&rsquo;s neighbors as well.</p>
<h4 class="relative group">Constrain 
    <div id="constrain" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#constrain" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">constrain_to_neighbor</span>(self, cell: Cell, face: str):
</span></span><span style="display:flex;"><span>    old <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>possibilities)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>possibilities <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        p
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>possibilities[]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> compatible_sockets(my_face, p[my_face], cell[face])
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> old <span style="color:#f92672">!=</span> len(self<span style="color:#f92672">.</span>possibilities)
</span></span></code></pre></div><p>Here, we reduce the possibility list to only include <code>Prototype</code>s that are compatible
on the opposing face.</p>
<p>There are far more efficient ways of doing this, like setting up an adjacency
table. This is also the part of the algorithm that will most likely have edge
cases to help guide the algorithm&rsquo;s behavior to produce specific results.</p>
<h3 class="relative group">Generating Sockets and Prototypes 
    <div id="generating-sockets-and-prototypes" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#generating-sockets-and-prototypes" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<h4 class="relative group">Sockets from Geometry 
    <div id="sockets-from-geometry" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#sockets-from-geometry" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        srcset="
        /tech/wfc-01-basic-wfc/02-basic-wfc/sockybocky_hu39040d884a6b719c706f595a9f35e751_171687_330x0_resize_box_3.png 330w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/sockybocky_hu39040d884a6b719c706f595a9f35e751_171687_660x0_resize_box_3.png 660w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/sockybocky_hu39040d884a6b719c706f595a9f35e751_171687_1024x0_resize_box_3.png 1024w,
        /tech/wfc-01-basic-wfc/02-basic-wfc/sockybocky_hu39040d884a6b719c706f595a9f35e751_171687_1320x0_resize_box_3.png 2x"
        src="/tech/wfc-01-basic-wfc/02-basic-wfc/sockybocky_hu39040d884a6b719c706f595a9f35e751_171687_660x0_resize_box_3.png"
        alt="socks"
      />
      
      
    </figure>
  

</p>
<p>To use the algorithm above will need to label each of our tiles with sockets.
We could do this by hand. 16 meshes, multiplied by their 6 cell
faces 96 labels would need to be written out. Why spend twenty minutes
doing something tedious when you can spend a couple hours automating it?</p>
<p>My strategy for automating this is to filter the vertices to only those that sit
on the face of the tile&rsquo;s bounding box, and generate a hash to use as the socket.
There are some special considerations, though:</p>
<ol>
<li>We need to know if a socket is a mirror of another socket.</li>
<li>If we want rotated <code>Prototype</code>s, we need to be able to rotate a socket.</li>
<li>For faces with no vertices, we must know if they&rsquo;re inside pieces or outside
pieces, otherwise we might expose some backfaces instead of generating
something manifold.</li>
</ol>
<p>Using a hash alone won&rsquo;t cut it; we would lose the vertex info. To handle this
we can map the hash to some friendly name, and use suffixes to indicate these
things.</p>
<ol>
<li><code>f</code> - a flipped version of a socket</li>
<li><code>s</code> - a socket that is symmetrical (no need to flip)</li>
<li><code>r0</code>, <code>r1</code>, <code>r2</code>, <code>r3</code> - number of 90 rotations done to a socket</li>
</ol>
<p>We&rsquo;re also going to have to look at some normal data
to cover that &ldquo;empty&rdquo; socket scenario.</p>
<p>Using the mesh data is pretty finnicky. It&rsquo;s hard to tell what direction things
are facing reliably. The requirements put on the artist to make near perfect
meshes are also very annoying. For high poly meshes, the implementation I have
here would be slow or not even work. I ended up mostly abandoning this
approach. I&rsquo;ll get into that in a later post.</p>
<p>The implementation can be found <a href="https://github.com/stevenctl/basic-wfc-blender/blob/main/wfc/adjacency.py"   target="_blank">
    here</a>
along with a sample Blender file you can use to run the code. Rather than
walking through the entire thing, I&rsquo;ll highlight some semi-interesting bits.</p>
<h5 class="relative group">Detecting Interiors 
    <div id="detecting-interiors" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#detecting-interiors" aria-label="Anchor">#</a>
    </span>        
    
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_interior</span>(o: bpy<span style="color:#f92672">.</span>types<span style="color:#f92672">.</span>Object, face):
</span></span><span style="display:flex;"><span>    axis, sign <span style="color:#f92672">=</span> get_axis(face)
</span></span><span style="display:flex;"><span>    detected_sign <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    max_poly <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>float(<span style="color:#e6db74">&#34;inf&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> o<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>polygons:
</span></span><span style="display:flex;"><span>        normal <span style="color:#f92672">=</span> Decimal(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;%.</span><span style="color:#e6db74">{</span>DECIMAL_PLACES<span style="color:#e6db74">}</span><span style="color:#e6db74">f&#34;</span> <span style="color:#f92672">%</span> p<span style="color:#f92672">.</span>normal[axis])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> normal<span style="color:#f92672">.</span>is_zero():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        normal_sign <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> normal <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> vert_idx <span style="color:#f92672">in</span> p<span style="color:#f92672">.</span>vertices:
</span></span><span style="display:flex;"><span>            vert_value <span style="color:#f92672">=</span> sign <span style="color:#f92672">*</span> o<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>vertices[vert_idx]<span style="color:#f92672">.</span>co[axis]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> vert_value <span style="color:#f92672">&gt;</span> max_poly:
</span></span><span style="display:flex;"><span>                detected_sign <span style="color:#f92672">=</span> normal_sign
</span></span><span style="display:flex;"><span>                max_poly <span style="color:#f92672">=</span> vert_value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> detected_sign <span style="color:#f92672">!=</span> sign:
</span></span></code></pre></div><p>I&rsquo;m just finding the <em>mesh</em> face that&rsquo;s furthest in the axis
for our tile face (north, west, top, etc.), and seeing if its
normal matches that direction.</p>
<p>This is a simplistic method that&rsquo;s prone to errors. It&rsquo;s good enough for
because the meshes are so simple. The plan was that I would run this on the
simple versions, and then re-use that data after I add details and art to the
meshes.</p>
<h2 class="relative group">Conclusion 
    <div id="conclusion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>While this post was mostly pseudo code, it matches up pretty well to my first
WFC attempt. The code is available
<a href="https://github.com/stevenctl/basic-wfc-blender"   target="_blank">
    here</a> as well as a sample
Blender file you can use to run it. This implementation has majorissues and
isn&rsquo;t scalable, but I found I use for it that&rsquo;s covered in a later post.</p>
<a id="github-43daf4aae0883dd36f9d2dec6696f6a4" target="_blank" href="https://github.com/stevenctl/basic-wfc-blender" class="cursor-pointer">
  <div
    class="w-full md:w-auto pt-3 p-5 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl">

    <div class="flex items-center">
      <span class="text-2xl text-neutral-800 dark:text-neutral" style="margin-right:10px;">
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


      </span>
      <div
        id="github-43daf4aae0883dd36f9d2dec6696f6a4-full_name"
        class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">
        stevenctl/basic-wfc-blender
      </div>
    </div>

    <p id="github-43daf4aae0883dd36f9d2dec6696f6a4-description" class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">
      Messy but functional WFC demos.
    </p>

    <div class="m-0 mt-2 flex items-center">

      <span class="mr-1 inline-block h-3 w-3 rounded-full"
        style="background-color: #3572A5"></span>
      <div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">
         Python 
      </div>

      <span class="text-md mr-1 text-neutral-800 dark:text-neutral">
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M287.9 0C297.1 0 305.5 5.25 309.5 13.52L378.1 154.8L531.4 177.5C540.4 178.8 547.8 185.1 550.7 193.7C553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4L459.9 483.9C461.4 492.9 457.7 502.1 450.2 507.4C442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9L150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4C118.2 502.1 114.5 492.9 115.1 483.9L142.2 328.4L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7C28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8L266.3 13.52C270.4 5.249 278.7 0 287.9 0L287.9 0zM287.9 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9L184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7L276.6 387.5C283.7 383.7 292.2 383.7 299.2 387.5L404.4 443.7L384.2 324.1C382.9 316.4 385.5 308.5 391 303L476.9 217.9L358.6 200.5C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg>
  </span>


      </span>
      <div id="github-43daf4aae0883dd36f9d2dec6696f6a4-stargazers" class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">
        0
      </div>

      <span class="text-md mr-1 text-neutral-800 dark:text-neutral">
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M80 104c13.3 0 24-10.7 24-24s-10.7-24-24-24S56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7 0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3c0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8 0 80C0 35.8 35.8 0 80 0s80 35.8 80 80zm208 24c13.3 0 24-10.7 24-24s-10.7-24-24-24s-24 10.7-24 24s10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24s10.7 24 24 24s24-10.7 24-24z"/></svg>
  </span>


      </span>
      <div id="github-43daf4aae0883dd36f9d2dec6696f6a4-forks" class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">
        0
      </div>

    </div>

  </div>
  <script>
    fetch("https://api.github.com/repos/stevenctl/basic-wfc-blender", {
      headers: new Headers({
        'User-agent': 'Mozilla/4.0 Custom User Agent'
      })
    })
      .then(response => response.json())
      .then(data => {
        document.getElementById('github-43daf4aae0883dd36f9d2dec6696f6a4-full_name').innerHTML = data.full_name;
        document.getElementById('github-43daf4aae0883dd36f9d2dec6696f6a4-description').innerHTML = data.description;
        document.getElementById('github-43daf4aae0883dd36f9d2dec6696f6a4-stargazers').innerHTML = data.stargazers_count;
        document.getElementById('github-43daf4aae0883dd36f9d2dec6696f6a4-forks').innerHTML = data.forks;
      })
      .catch(error => console.error(error))
  </script>
</a>

        </div>
                
        

        

          
      </div>
     
    
     <script>
        var oid = "views_tech\/wfc-01-basic-wfc\/index.md"
        var oid_likes = "likes_tech\/wfc-01-basic-wfc\/index.md"
      </script>
      
      
      
      <script type="text/javascript" src="/js/page.min.5b1bad196a6075a1e11bae1dc95f24f67b610948a00525e347566c5a62338ea78f1c7224ab9a53873dcdb2a1a7d7d391b8a8ef45561297f68806c01315b0c4f6.js" integrity="sha512-WxutGWpgdaHhG64dyV8k9nthCUigBSXjR1ZsWmIzjqePHHIkq5pThz3NsqGn19ORuKjvRVYSl/aIBsATFbDE9g=="></script>
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/tech/wfc-02-advanced-wfc/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >3D Autotiling: Expanding and Optimizing</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      Steven Landow
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js" integrity="sha512-YgYLskf03itt3kWQNmj&#43;&#43;2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script>
  
  
</footer>
  </div>
</body>

</html>
